<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'> 
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.1.0/pure-min.css">
  <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js"></script>
  <title>School Mapper</title>
  <style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0px; padding: 0px }
    .google-map{width:100%; height:100%;}
    
    #view_tab {
    	width: 300px;
    	height: 500px;
    	position: absolute;
    	left: 20px;
    	top: 20px;
    	border-radius: 20px;
    	background-color: #ffffff;
    	padding: 20px;
    }
  </style>
</head>
<body ng-app="mapComponentsApp">
  <div class="google-map" hello-maps="" latitude="53.381129" longitude="-1.470085"></div>
  
  
  <div id="view_tab" ng-controller="theController">       
    Lat: {{center.lat}}</br>
    Lng: {{center.lng}}</br>
  </div>

  <script type="text/javascript">
    var mapApp = angular.module('mapComponentsApp', []);

    mapApp.directive('helloMaps', function (mapService) {
      return function (scope, elem, attrs) {
        var mapOptions,
          latitude = attrs.latitude,
          longitude = attrs.longitude,
          map;

        latitude = latitude && parseFloat(latitude, 10) || 43.074688;
        longitude = longitude && parseFloat(longitude, 10) || -89.384294;

        mapOptions = {
          zoom: 13,
          center: new google.maps.LatLng(latitude, longitude),
		mapTypeControl: true,
		mapTypeControlOptions: {
			position: google.maps.ControlPosition.BOTTOM_RIGHT
		},
		panControl: true,
		panControlOptions: {
			position: google.maps.ControlPosition.TOP_RIGHT
		},
		zoomControl: true,
		zoomControlOptions: {
			style: google.maps.ZoomControlStyle.LARGE,
			position: google.maps.ControlPosition.TOP_RIGHT
		},
		scaleControl: true
        };

        map = new google.maps.Map(elem[0], mapOptions);
        mapService.setMap(map);
        
		var school_layer = new google.maps.FusionTablesLayer({
		  query: {
			select: 'PCODE',
			from: '1ewb041RP_gOwqC5tazqe1sr6pxmphVo7fR_mokU'
		  },
		});
		school_layer.setMap(map);        
		
		var wards_layer = new google.maps.FusionTablesLayer({
		  query: {
			select: 'Location Polygon',
			from: '1C6wwkVW9tRQJ5r3Aq-UoTW960cA957XgZ0u03s4'
		  },
		});
		wards_layer.setMap(map);        		
      };
    });    
    
   mapApp.service('mapService', function () {
      var map;
      this.setMap = function (myMap) {
        map = myMap;
      };
      this.getMap = function () {
        if (map) return map;
        throw new Error("Map not defined");
      };
      this.getLatLng = function () {
        var center = map.getCenter();
        return {
          lat: center.lat(),
          lng: center.lng()
        };        
      };
      this.addListener = function(event, listener) {
          google.maps.event.addListener(map, event, listener);
      };            
    });    
    
    mapApp.controller('theController', function($scope, mapService) {
    	$scope.center =  {
    	  lat: mapService.getLatLng().lat,
    	  lng: mapService.getLatLng().lng
    	};
    	
    	$scope.setCenter = function() {
    	  var newCenter = mapService.getLatLng();
    	  $scope.center.lat = newCenter.lat;
    	  $scope.center.lng = newCenter.lng;
    	};    	
    
        $scope.setCenter();
            
    	mapService.addListener('center_changed', function() {
    	  $scope.$apply(function () {
			$scope.setCenter();
    	  });    	
    	});    
    });
  </script>
</body>
</html>